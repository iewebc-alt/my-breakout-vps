#!/bin/bash

# r.sh ‚Äî –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
# –ü—É—Ç—å: /var/www/breakout_dev

PROJECT_DIR="/var/www/breakout_dev"
BACKUP_DIR="$PROJECT_DIR/ARX"

cd "$BACKUP_DIR" || { echo "‚ùå –ü–∞–ø–∫–∞ ARX –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }

# 1. –í—ã–≤–æ–¥ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤
echo "üìÇ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–æ—á–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:"
echo "-------------------------------------------------------"
i=1
# –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞—Ä—Ö–∏–≤–æ–≤ –≤ –º–∞—Å—Å–∏–≤
files=(bk_*.tar.gz)

for file in "${files[@]}"; do
    # –ß–∏—Ç–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π .txt —Ñ–∞–π–ª —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
    comment_file="${file%.tar.gz}.txt"
    comment=$(cat "$comment_file" 2>/dev/null || echo "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è")
    echo "[$i] $file ‚Äî $comment"
    ((i++))
done
echo "-------------------------------------------------------"

# 2. –í—ã–±–æ—Ä –∞—Ä—Ö–∏–≤–∞
echo "üî¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞):"
read choice

if [[ "$choice" == "q" ]]; then exit; fi

selected_file="${files[$((choice-1))]}"

if [ -z "$selected_file" ]; then
    echo "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä"
    exit 1
fi

# 3. –í—ã–±–æ—Ä –æ–±–ª–∞—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–µ—Å—Ç—Ä–∞)
echo -e "\nüõ†Ô∏è –ß—Ç–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∞—Ä—Ö–∏–≤–∞?"
echo "[1] –í–µ—Å—å –ø—Ä–æ–µ–∫—Ç (Full Restore)"
echo "[2] –¢–æ–ª—å–∫–æ –ª–æ–≥–∏–∫—É (physics.js, state.js, config.js)"
echo "[3] –¢–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª (renderer.js, index.html)"
echo "[4] –¢–æ–ª—å–∫–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (input.js)"
read type_choice

cd "$PROJECT_DIR" || exit

case $type_choice in
    1)
        echo "üöÄ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞..."
        tar -xzf "$BACKUP_DIR/$selected_file"
        ;;
    2)
        echo "üß† –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ —è–¥—Ä–∞..."
        tar -xzf "$BACKUP_DIR/$selected_file" physics.js state.js config.js
        ;;
    3)
        echo "üé® –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª—å–Ω–æ–π —á–∞—Å—Ç–∏..."
        tar -xzf "$BACKUP_DIR/$selected_file" renderer.js index.html
        ;;
    4)
        echo "üïπÔ∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã –≤–≤–æ–¥–∞..."
        tar -xzf "$BACKUP_DIR/$selected_file" input.js
        ;;
    *)
        echo "‚ùå –û—Ç–º–µ–Ω–∞"
        exit 1
        ;;
esac

echo "‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "üîÑ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å ./update_dev.sh –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞."