#!/bin/bash

# –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∞—Ä—Ö–∏–≤–∞–º–∏
BACKUP_DIR="/var/www/backups/full_versions"
# –¢–µ–∫—É—â–∞—è —Ä–∞–±–æ—á–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è
TARGET_DIR=$(pwd)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–∞–ø–∫–∏ —Å –±—ç–∫–∞–ø–∞–º–∏
if [ ! -d "$BACKUP_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ü–∞–ø–∫–∞ —Å –∞—Ä—Ö–∏–≤–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ –ø—É—Ç–∏ $BACKUP_DIR"
    exit 1
fi

# –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ ZIP —Ñ–∞–π–ª–æ–≤
cd "$BACKUP_DIR" || exit
files=(*.zip)

# –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ
if [ ${#files[@]} -eq 0 ] || [ "${files[0]}" == "*.zip" ]; then
    echo "üìÇ –í –ø–∞–ø–∫–µ $BACKUP_DIR –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—Ä—Ö–∏–≤–æ–≤ (.zip)"
    exit 1
fi

echo "-------------------------------------------------------"
echo "üìú –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–µ—Ä—Å–∏–π –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:"
echo "-------------------------------------------------------"

# –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ —Å –Ω–æ–º–µ—Ä–∞–º–∏
for i in "${!files[@]}"; do
    printf "[%2d] %s\n" "$((i+1))" "${files[$i]}"
done

echo "-------------------------------------------------------"
echo "üî¢ –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–∏–ª–∏ 'q' –¥–ª—è –≤—ã—Ö–æ–¥–∞):"
read -r choice

if [[ "$choice" == "q" ]]; then
    echo "üëã –û—Ç–º–µ–Ω–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è."
    exit 0
fi

if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#files[@]}" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä."
    exit 1
fi

SELECTED_FILE="${files[$((choice-1))]}"

echo -e "\n‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –§–∞–π–ª—ã –≤ $TARGET_DIR –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã."
echo "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ $SELECTED_FILE? (y/n)"
read -r confirm

if [[ "$confirm" != "y" ]]; then
    echo "‚ùå –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ."
    exit 0
fi

cd "$TARGET_DIR" || exit
echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ $SELECTED_FILE..."

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
unzip -o "$BACKUP_DIR/$SELECTED_FILE" -d "$TARGET_DIR"

if [ $? -eq 0 ]; then
    echo "üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (chmod 755)..."
    # –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ô –§–ò–ö–° –ü–†–ê–í
    chmod -R 755 "$TARGET_DIR"
    
    echo "-------------------------------------------------------"
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!"
    echo "üöÄ –ó–∞–ø—É—Å–∫–∞—é –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É Docker..."
    echo "-------------------------------------------------------"
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    if [ -f "./update_dev.sh" ]; then
        ./update_dev.sh
    else
        echo "‚ö†Ô∏è  –§–∞–π–ª update_dev.sh –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ Docker –≤—Ä—É—á–Ω—É—é."
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–µ –∞—Ä—Ö–∏–≤–∞."
fi
